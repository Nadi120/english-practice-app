<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Practice</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js">
function updateMCQStageCount(){
  const totalStages = Math.max(1, Math.ceil(words.length/10));
  const el = document.getElementById('mcqMenuStages');
  if(el) el.textContent = totalStages;
}

updateMCQStageCount();

function updateWordCount(){
  const el=document.getElementById('wordCount');
  if(el) el.textContent = words.length;
}

updateWordCount();

function showMCQSummary(){
  const box=document.getElementById('mcqSummaryBox');
  if(!box) return;
  if(mcqMistakes.length===0){
    box.innerHTML='ğŸ‰ ×œ× ×”×™×• ×˜×¢×•×™×•×ª ×‘×©×œ×‘ ×”×–×”!';
  }else{
    box.innerHTML='<b>×˜×¢×•×™×•×ª ×‘×©×œ×‘:</b><br>'+
      mcqMistakes.map(w=>`â€¢ ${w.en} â†’ ${w.he}`).join('<br>');
  }
  box.style.display='block';
}


function ensureSentencesCoverage(){
  if(sentences.length >= words.length) return;

  const existing = new Set(sentences.map(s=>s.word.toLowerCase()));
  words.forEach(w=>{
    if(!existing.has(w.en.toLowerCase())){
      sentences.push({
        word:w.en,
        template:`I often use ______ in my daily life.`,
        he:w.he
      });
    }
  });
}

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js">
function updateMCQStageCount(){
  const totalStages = Math.max(1, Math.ceil(words.length/10));
  const el = document.getElementById('mcqMenuStages');
  if(el) el.textContent = totalStages;
}

updateMCQStageCount();

function updateWordCount(){
  const el=document.getElementById('wordCount');
  if(el) el.textContent = words.length;
}

updateWordCount();

function showMCQSummary(){
  const box=document.getElementById('mcqSummaryBox');
  if(!box) return;
  if(mcqMistakes.length===0){
    box.innerHTML='ğŸ‰ ×œ× ×”×™×• ×˜×¢×•×™×•×ª ×‘×©×œ×‘ ×”×–×”!';
  }else{
    box.innerHTML='<b>×˜×¢×•×™×•×ª ×‘×©×œ×‘:</b><br>'+
      mcqMistakes.map(w=>`â€¢ ${w.en} â†’ ${w.he}`).join('<br>');
  }
  box.style.display='block';
}


function ensureSentencesCoverage(){
  if(sentences.length >= words.length) return;

  const existing = new Set(sentences.map(s=>s.word.toLowerCase()));
  words.forEach(w=>{
    if(!existing.has(w.en.toLowerCase())){
      sentences.push({
        word:w.en,
        template:`I often use ______ in my daily life.`,
        he:w.he
      });
    }
  });
}

</script>
<style>
:root{
  --bg:#0f1b2d;
  --card:#1a2d4a;
  --card2:#1f3660;
  --accent:#f7c948;
  --accent2:#4fc3f7;
  --accent3:#ff7eb3;
  --green:#56d48e;
  --red:#ff5c6a;
  --text:#e8f4ff;
  --sub:#8ab4d4;
  --radius:20px;
  --radius-sm:12px;
}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Assistant',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:0;overflow-x:hidden}

/* Stars background */
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,#1a3a6a22 0%,transparent 60%),radial-gradient(ellipse at 80% 80%,#0d2a4422 0%,transparent 60%);pointer-events:none}

.screen{display:none;min-height:100vh;padding:20px}
.screen.active{display:flex;flex-direction:column}

/* ====== MENU ====== */
#menu{align-items:center;justify-content:center;gap:24px}
.menu-title{font-family:'Fredoka One',cursive;font-size:42px;color:var(--accent);text-shadow:0 0 30px #f7c94866;letter-spacing:2px;text-align:center;margin-bottom:8px}
.menu-sub{color:var(--sub);font-size:16px;text-align:center;margin-bottom:20px}
.menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;width:100%;max-width:480px}
.menu-card{
  background:var(--card);
  border:2px solid transparent;
  padding:28px 16px;
  border-radius:var(--radius);
  text-align:center;
  cursor:pointer;
  transition:all .25s;
  position:relative;
  overflow:hidden;
}
.menu-card::before{content:'';position:absolute;inset:0;opacity:0;transition:.3s}
.menu-card:hover{transform:translateY(-4px);border-color:var(--accent)}
.menu-card:hover::before{opacity:1}
.menu-card.c1::before{background:linear-gradient(135deg,#f7c94811,#f7c94822)}
.menu-card.c2::before{background:linear-gradient(135deg,#4fc3f711,#4fc3f722)}
.menu-card.c3::before{background:linear-gradient(135deg,#ff7eb311,#ff7eb322)}
.menu-card.c4::before{background:linear-gradient(135deg,#56d48e11,#56d48e22)}
.menu-icon{font-size:44px;margin-bottom:10px}
.menu-label{font-size:17px;font-weight:700;color:var(--text)}
.menu-desc{font-size:12px;color:var(--sub);margin-top:4px}

/* ====== SHARED ====== */
.top-bar{display:flex;align-items:center;gap:12px;margin-bottom:18px}
.back-btn{background:var(--card);border:none;color:var(--sub);padding:10px 16px;border-radius:var(--radius-sm);cursor:pointer;font-size:16px;transition:.2s}
.back-btn:hover{color:var(--text);background:var(--card2)}
.mode-title{font-family:'Fredoka One',cursive;font-size:26px;color:var(--accent)}

.stats-bar{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px}
.stat-pill{background:var(--card);padding:8px 14px;border-radius:30px;font-size:14px;color:var(--sub)}
.stat-pill span{color:var(--accent);font-weight:700}

.progress-wrap{height:10px;background:var(--card);border-radius:10px;overflow:hidden;margin-bottom:20px}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent2),var(--accent));transition:width .4s;border-radius:10px}

/* ====== MCQ ====== */
#mcq{max-width:540px;margin:0 auto;width:100%}
.question-card{background:var(--card);border-radius:var(--radius);padding:32px 24px;text-align:center;margin-bottom:20px;border:2px solid var(--card2)}
.question-label{color:var(--sub);font-size:14px;margin-bottom:8px}
.question-word{font-family:'Fredoka One',cursive;font-size:48px;color:var(--accent);letter-spacing:1px}
.question-he{font-size:16px;color:var(--sub);margin-top:6px}
.answers-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px}
.ans-btn{
  background:var(--card);border:2px solid var(--card2);color:var(--text);
  padding:18px 10px;border-radius:var(--radius-sm);font-size:16px;font-weight:600;
  cursor:pointer;transition:.2s;font-family:'Assistant',sans-serif;
}
.ans-btn:hover:not(:disabled){background:var(--card2);border-color:var(--accent2)}
.ans-btn.correct{background:#1a4a2e;border-color:var(--green);color:var(--green)}
.ans-btn.wrong{background:#4a1a1e;border-color:var(--red);color:var(--red)}
.ans-btn:disabled{cursor:default}

.stage-banner{background:linear-gradient(135deg,var(--card),var(--card2));border:2px solid var(--accent);border-radius:var(--radius);padding:24px;text-align:center;margin-bottom:20px;display:none}
.stage-banner h2{font-family:'Fredoka One',cursive;font-size:30px;color:var(--accent);margin-bottom:8px}

/* ====== SENTENCES ====== */
#sentences{max-width:540px;margin:0 auto;width:100%}
.sent-card{background:var(--card);border-radius:var(--radius);padding:28px 24px;margin-bottom:16px;border:2px solid var(--card2)}
.sent-label{color:var(--sub);font-size:13px;margin-bottom:12px}
.sent-text{font-size:22px;line-height:1.7;color:var(--text);direction:ltr;text-align:left}
.sent-text .blank{display:inline-block;min-width:100px;color:var(--accent);font-weight:700;padding:0 8px;vertical-align:middle;background:#f7c94811;border-radius:6px}
.sent-input{width:100%;padding:16px;font-size:18px;border-radius:var(--radius-sm);border:2px solid var(--card2);background:var(--card2);color:var(--text);outline:none;margin-top:16px;font-family:'Assistant',sans-serif;direction:ltr;transition:.2s}
.sent-input:focus{border-color:var(--accent2)}
.sent-input.correct-input{border-color:var(--green);background:#1a4a2e}
.sent-input.wrong-input{border-color:var(--red);background:#4a1a1e}
.sent-feedback{margin-top:12px;font-size:15px;min-height:24px;text-align:center;font-weight:600}
.hint-box{background:var(--card2);border-radius:var(--radius-sm);padding:16px;margin-top:12px;display:none}
.hint-box .hint-title{color:var(--sub);font-size:13px;margin-bottom:8px}
.hint-opts{display:flex;gap:8px;flex-wrap:wrap}
.hint-opt{background:var(--card);border:2px solid var(--card2);color:var(--text);padding:8px 14px;border-radius:30px;font-size:15px;cursor:pointer;font-family:'Assistant',sans-serif}
.hint-opt:hover{border-color:var(--accent2);color:var(--accent2)}
.action-row{display:flex;gap:10px;margin-top:14px}
.btn{padding:14px 20px;border:none;border-radius:var(--radius-sm);font-size:16px;font-weight:700;cursor:pointer;font-family:'Assistant',sans-serif;transition:.2s;flex:1}
.btn-primary{background:var(--accent);color:#0f1b2d}
.btn-primary:hover{background:#f5d96e}
.btn-secondary{background:var(--card2);color:var(--sub)}
.btn-secondary:hover{color:var(--text);background:#2a4070}

/* ====== AUDIO MODE ====== */
#audio-mode{max-width:540px;margin:0 auto;width:100%;align-items:center}
.audio-card{background:var(--card);border-radius:var(--radius);padding:36px 24px;text-align:center;margin-bottom:20px;border:2px solid var(--card2);width:100%}
.speak-btn{
  width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,var(--accent2),var(--accent));
  border:none;cursor:pointer;font-size:50px;margin:20px auto;display:flex;align-items:center;justify-content:center;
  box-shadow:0 0 40px #4fc3f744;transition:all .2s;
}
.speak-btn:hover{transform:scale(1.08);box-shadow:0 0 60px #4fc3f766}
.speak-btn:active{transform:scale(.95)}
.audio-word-he{font-size:30px;color:var(--text);font-weight:700;margin-bottom:8px}
.audio-word-en{font-size:20px;color:var(--sub);display:none;margin-top:8px;direction:ltr}
.reveal-btn{background:var(--card2);border:2px solid var(--card2);color:var(--sub);padding:12px 24px;border-radius:var(--radius-sm);cursor:pointer;font-size:16px;font-family:'Assistant',sans-serif;transition:.2s}
.reveal-btn:hover{color:var(--text);border-color:var(--accent)}
.audio-nav{display:flex;gap:12px;width:100%;margin-top:8px}

/* ====== TEXT MODE ====== */
#text-mode{max-width:540px;margin:0 auto;width:100%}
.text-instructions{background:var(--card2);border-radius:var(--radius-sm);padding:16px;margin-bottom:16px;font-size:14px;color:var(--sub);direction:rtl}
.text-instructions b{color:var(--accent)}
.words-bank{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px}
.word-chip{background:var(--card2);border:1px solid var(--card2);color:var(--accent2);padding:6px 12px;border-radius:20px;font-size:14px;direction:ltr}
.word-chip.used{opacity:.35;text-decoration:line-through}
.text-area{width:100%;height:160px;padding:16px;font-size:17px;border-radius:var(--radius-sm);border:2px solid var(--card2);background:var(--card);color:var(--text);outline:none;resize:none;font-family:'Assistant',sans-serif;direction:ltr;line-height:1.8;transition:.2s}
.text-area:focus{border-color:var(--accent2)}
.text-feedback{margin-top:16px;background:var(--card2);border-radius:var(--radius-sm);padding:16px;display:none}
.text-feedback-title{color:var(--accent);font-weight:700;margin-bottom:10px;font-size:16px}
.correction-line{margin-bottom:8px;font-size:14px;direction:ltr;line-height:1.6}
.err-word{background:#4a1a1e;color:var(--red);padding:2px 6px;border-radius:4px;text-decoration:line-through}
.corr-word{background:#1a4a2e;color:var(--green);padding:2px 6px;border-radius:4px}
.ok-line{color:var(--green);font-size:14px}

/* ====== CELEBRATION ====== */
@keyframes pop{0%{transform:scale(.5);opacity:0}70%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
.celebrate{animation:pop .4s ease-out}
.floating{animation:float 2s ease-in-out infinite}

@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.fade-in{animation:fadeIn .3s ease}

.round-end{background:var(--card);border:2px solid var(--accent);border-radius:var(--radius);padding:32px;text-align:center;display:none}
.round-end h2{font-family:'Fredoka One',cursive;font-size:32px;color:var(--accent);margin-bottom:12px}
.round-score{font-size:48px;font-family:'Fredoka One',cursive;color:var(--accent2);margin:12px 0}
.round-end p{color:var(--sub);margin-bottom:20px}

/* ====== TIMER ====== */
.timer-btn{
  background:var(--card2);border:2px solid var(--accent);color:var(--accent);
  padding:7px 14px;border-radius:30px;cursor:pointer;font-size:14px;font-weight:700;
  font-family:'Assistant',sans-serif;transition:.2s;white-space:nowrap;
}
.timer-btn:hover{background:var(--accent);color:#0f1b2d}
.timer-btn.running{background:#1a4a2e;border-color:var(--green);color:var(--green)}
</style>
</head>
<body>

<!-- MENU -->
<div id="menu" class="screen active">
  <div class="menu-title floating">âœ¨ English Practice</div>
  <div class="menu-sub" id="menuSub"><span id="wordCount">111</span> ××™×œ×™× | 4 ××¦×‘×™ ×ª×¨×’×•×œ</div>
  <div class="menu-grid">
    <div class="menu-card c1" onclick="startMCQ()">
      <div class="menu-icon">ğŸ§ </div>
      <div class="menu-label">×¨×‘ ×‘×¨×™×¨×”</div>
      <div class="menu-desc"><span id="mcqMenuStages">10</span> ×©×œ×‘×™× Ã— 10 ×©××œ×•×ª</div>
    </div>
    <div class="menu-card c2" onclick="startSentences()">
      <div class="menu-icon">âœï¸</div>
      <div class="menu-label">×”×©×œ××ª ××©×¤×˜×™×</div>
      <div class="menu-desc">×›×ª×•×‘ ××ª ×”××™×œ×” ×”×—×¡×¨×”</div>
    </div>
    <div class="menu-card c3" onclick="startAudio()">
      <div class="menu-icon">ğŸ”Š</div>
      <div class="menu-label">×”×©××¢×ª ××™×œ×™×</div>
      <div class="menu-desc">×©××¢, ×–×›×•×¨, ×’×œ×”</div>
    </div>
    <div class="menu-card c4" onclick="startText()">
      <div class="menu-icon">ğŸ“</div>
      <div class="menu-label">×›×ª×™×‘×” ×—×•×¤×©×™×ª</div>
      <div class="menu-desc">×›×ª×•×‘ ××©×¤×˜×™× ×•×ª×•×§× ×•</div>
    </div>
  </div>
  <div style="margin-top:18px;width:100%;max-width:480px">
    <div class="menu-card" style="grid-column:1/-1;border:2px dashed var(--accent2);background:transparent" onclick="showCustomWords()">
      <div class="menu-icon">ğŸ“‚</div>
      <div class="menu-label" style="color:var(--accent2)">×˜×¢×Ÿ ×¨×©×™××ª ××™×œ×™× ××©×œ×š</div>
      <div class="menu-desc">×”×“×‘×§ ××™×œ×™× ×•×ª×¨×’×•×œ×™× ×™×ª××™××• ×œ×”×Ÿ</div>
    </div>
  </div>
</div>

<!-- CUSTOM WORDS -->
<div id="custom-words" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="goMenu()">â† ×ª×¤×¨×™×˜</button>
    <div class="mode-title">ğŸ“‚ ×¨×©×™××ª ××™×œ×™× ××©×œ×š</div>
  </div>

  <!-- File upload -->
  <div style="background:var(--card);border:2px dashed var(--accent2);border-radius:var(--radius-sm);padding:16px;margin-bottom:12px;text-align:center;cursor:pointer" onclick="document.getElementById('fileUpload').click()">
    <div style="font-size:32px;margin-bottom:6px">ğŸ“„</div>
    <div style="color:var(--accent2);font-weight:700;font-size:15px">×”×¢×œ×” ×§×•×‘×¥ Word / PDF / TXT</div>
    <div style="color:var(--sub);font-size:12px;margin-top:4px">×œ×—×¥ ×œ×‘×—×™×¨×ª ×§×•×‘×¥ ××”××—×©×‘ ××• ×”×˜×œ×¤×•×Ÿ</div>
    <input type="file" id="fileUpload" accept=".txt,.docx,.doc,.pdf" style="display:none" onchange="handleFileUpload(event)">
  </div>
  <div id="fileStatus" style="text-align:center;font-size:13px;color:var(--accent);margin-bottom:8px;min-height:18px"></div>

  <div style="text-align:center;color:var(--sub);font-size:13px;margin-bottom:8px">â€” ××• ×”×“×‘×§ ×˜×§×¡×˜ ×™×©×™×¨×•×ª â€”</div>

  <div style="background:var(--card2);border-radius:var(--radius-sm);padding:12px;margin-bottom:10px;font-size:13px;color:var(--sub);direction:rtl;line-height:1.7">
    ×¤×•×¨××˜: <b style="color:var(--accent)">×× ×’×œ×™×ª = ×¢×‘×¨×™×ª</b> &nbsp;|&nbsp;
    <b style="color:var(--accent)">×× ×’×œ×™×ª - ×¢×‘×¨×™×ª</b> &nbsp;|&nbsp;
    <b style="color:var(--accent)">×× ×’×œ×™×ª : ×¢×‘×¨×™×ª</b>
  </div>
  <textarea id="customInput" style="width:100%;height:180px;padding:14px;font-size:15px;border-radius:var(--radius-sm);border:2px solid var(--card2);background:var(--card);color:var(--text);outline:none;resize:none;font-family:'Assistant',sans-serif;direction:ltr;line-height:1.8;transition:.2s" placeholder="feather = × ×•×¦×”&#10;fur = ×¤×¨×•×•×”&#10;mud = ×‘×•×¥&#10;adventure = ×”×¨×¤×ª×§××”"></textarea>
  <div id="customFeedback" style="margin:10px 0;font-size:14px;color:var(--sub);text-align:center;min-height:20px"></div>

  <!-- Loading indicator -->
  <div id="customLoading" style="display:none;text-align:center;padding:20px">
    <div style="font-size:32px;animation:float 1.5s ease-in-out infinite">âš™ï¸</div>
    <div style="color:var(--accent2);font-size:16px;margin-top:10px">×™×•×¦×¨ ××©×¤×˜×™× ×œ×ª×¨×’×•×œ...</div>
    <div id="loadingProgress" style="color:var(--sub);font-size:13px;margin-top:6px"></div>
  </div>

  <div id="customBtns" style="display:flex;gap:10px;margin-top:4px">
    <button class="btn btn-primary" onclick="loadCustomWords()" style="flex:2">âœ“ ×˜×¢×Ÿ ××™×œ×™× ×•×ª×ª×—×™×œ</button>
    <button class="btn btn-secondary" onclick="resetToDefault()" style="flex:1">â†º ×‘×¨×™×¨×ª ××—×“×œ</button>
  </div>
</div>

<!-- MCQ -->
<div id="mcq" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="goMenu()">â† ×ª×¤×¨×™×˜</button>
    <div class="mode-title">ğŸ§  ×¨×‘ ×‘×¨×™×¨×”</div>
    <div style="margin-right:auto;display:flex;align-items:center;gap:8px">
      <div class="timer-display" id="mcqTimerDisplay" style="font-family:'Fredoka One',cursive;font-size:22px;color:var(--accent);min-width:56px;text-align:center">00:00</div>
      <button class="timer-btn" id="mcqTimerBtn" onclick="toggleTimer('mcq')">â–¶ ×©×¢×•×Ÿ</button>
    </div>
  </div>
  <div class="stats-bar">
    <div class="stat-pill">×©×œ×‘ <span id="mcqStage">1</span>/<span id="mcqStageTotal">1</span></div>
    <div class="stat-pill">×©××œ×” <span id="mcqQ">0</span>/10</div>
    <div class="stat-pill">×©×œ×‘: <span id="mcqStageScore">0</span></div>
    <div class="stat-pill">×¡×”"×›: <span id="mcqTotal">0</span></div>
  </div>
  <div class="progress-wrap"><div class="progress-fill" id="mcqBar" style="width:0%"></div></div>

  <div class="round-end" id="mcqRound">
    <div id="mcqSummaryBox" style="display:none;margin-bottom:16px;text-align:right;background:var(--card2);padding:12px;border-radius:12px;font-size:14px"></div>
    <h2>ğŸ‰ ×¡×™×•× ×©×œ×‘!</h2>
    <div class="round-score" id="mcqRoundScore"></div>
    <p id="mcqRoundMsg"></p>
    <div style="color:var(--accent2);font-size:16px;margin-bottom:16px">â± ×–××Ÿ ×”×©×œ×‘: <b id="mcqRoundTime">--:--</b></div>
    <div style="display:flex;flex-direction:column;gap:10px">
      <button class="btn btn-secondary" onclick="showMCQSummary()" style="border:2px solid var(--accent2);color:var(--accent2)">ğŸ“‹ ×¡×™×›×•× ×˜×¢×•×™×•×ª</button>
      <button class="btn btn-primary" onclick="continueMCQ()">×”××©×š ×œ×©×œ×‘ ×”×‘× â–¶</button>
      <button class="btn btn-secondary" id="mcqRetryBtn" onclick="retryMCQ()" style="border:2px solid var(--accent3);color:var(--accent3)">ğŸ” ×—×–×•×¨ ×¢×œ ×”×©×œ×‘ ×”×–×”</button>
    </div>
  </div>

  <div id="mcqPlay">
    <div class="question-card fade-in">
      <div class="question-label">×ª×¨×’× ×œ×¢×‘×¨×™×ª ğŸ‘‡</div>
      <div class="question-word" id="mcqWord">word</div>
    </div>
    <div class="answers-grid" id="mcqAnswers"></div>
  </div>
</div>

<!-- SENTENCES -->
<div id="sentences" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="goMenu()">â† ×ª×¤×¨×™×˜</button>
    <div class="mode-title">âœï¸ ×”×©×œ××ª ××©×¤×˜×™×</div>
    <div style="margin-right:auto;display:flex;align-items:center;gap:8px">
      <div class="timer-display" id="sentTimerDisplay" style="font-family:'Fredoka One',cursive;font-size:22px;color:var(--accent);min-width:56px;text-align:center">00:00</div>
      <button class="timer-btn" id="sentTimerBtn" onclick="toggleTimer('sent')">â–¶ ×©×¢×•×Ÿ</button>
    </div>
  </div>
  <div class="stats-bar">
    <div class="stat-pill">×©×œ×‘ <span id="sentStage">1</span>/<span id="sentStageTotal">1</span></div>
    <div class="stat-pill">×©××œ×” <span id="sentQ">0</span>/10</div>
    <div class="stat-pill">×©×œ×‘: <span id="sentScore">0</span> × ×§'</div>
    <div class="stat-pill">×¡×”"×›: <span id="sentTotal">0</span> × ×§'</div>
  </div>
  <div style="font-size:12px;color:var(--sub);margin-bottom:10px;text-align:center">× ×™×§×•×“: âœ… × ×›×•×Ÿ=3× ×§' | ğŸ’¡×¨××–1+× ×›×•×Ÿ=2× ×§' | ğŸ’¡ğŸ’¡×¨××–2+× ×›×•×Ÿ=1× ×§'</div>
  <div class="progress-wrap"><div class="progress-fill" id="sentBar" style="width:0%"></div></div>

  <div class="round-end" id="sentRound">
    <h2>ğŸ‰ ×¡×™×•× ×©×œ×‘!</h2>
    <div class="round-score" id="sentRoundScore"></div>
    <p id="sentRoundMsg"></p>
    <div style="color:var(--accent2);font-size:16px;margin-bottom:16px">â± ×–××Ÿ ×”×©×œ×‘: <b id="sentRoundTime">--:--</b></div>
    <div style="display:flex;flex-direction:column;gap:10px">
      <button class="btn btn-primary" onclick="continueSent()">×”××©×š ×œ×©×œ×‘ ×”×‘× â–¶</button>
      <button class="btn btn-secondary" id="sentRetryBtn" onclick="retrySent()" style="border:2px solid var(--accent3);color:var(--accent3)">ğŸ” ×—×–×•×¨ ×¢×œ ×”×©×œ×‘ ×”×–×”</button>
    </div>
  </div>

  <div id="sentPlay">
    <div class="sent-card">
      <div class="sent-label">×”×©×œ× ××ª ×”××©×¤×˜ ×¢× ×”××™×œ×” ×”××ª××™××” (×‘×× ×’×œ×™×ª)</div>
      <div class="sent-text" id="sentText"></div>
      <input class="sent-input" id="sentInput" placeholder="Type the missing word..." dir="ltr" onkeydown="if(event.key==='Enter')checkSent()" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <div class="sent-feedback" id="sentFeedback"></div>
    </div>
    <div class="hint-box" id="hintBox">
      <div class="hint-title" id="hintTitle">ğŸ’¡ ×¨××– 1 â€“ ×ª×¨×’×•×:</div>
      <div class="hint-opts" id="hintOpts"></div>
    </div>
    <div style="text-align:center;margin-bottom:6px;font-size:13px;color:var(--sub)" id="hintInfo"></div>
    <div class="action-row">
      <button class="btn btn-primary" onclick="checkSent()">âœ“ ×‘×“×•×§</button>
      <button class="btn btn-secondary" id="hintBtn" onclick="showSentHint()">ğŸ’¡ ×¨××– 1</button>
      <button class="btn btn-secondary" onclick="skipSent()">×“×œ×’ â–¶</button>
    </div>
  </div>
</div>

<!-- AUDIO -->
<div id="audio-mode" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="goMenu()">â† ×ª×¤×¨×™×˜</button>
    <div class="mode-title">ğŸ”Š ×”×©××¢×ª ××™×œ×™×</div>
  </div>
  <div class="stats-bar">
    <div class="stat-pill">××™×œ×” <span id="audioIdx">1</span>/<span id="audioTotal">111</span></div>
  </div>
  <div class="audio-card">
    <div style="color:var(--sub);font-size:13px;margin-bottom:6px">××™×œ×” ×‘×× ×’×œ×™×ª</div>
    <div class="audio-word-he" id="audioEn" style="font-family:'Fredoka One',cursive;font-size:36px;color:var(--accent);direction:ltr">×˜×•×¢×Ÿ...</div>
    <button class="speak-btn" onclick="speakCurrent()" title="×”×©××¢ ××™×œ×”">ğŸ”Š</button>
    <div style="color:var(--sub);font-size:14px;margin-bottom:16px">×œ×—×¥ ×œ×”×©××¢×”</div>
    <button class="reveal-btn" id="audioRevealBtn" onclick="toggleReveal()">×”×¦×’ ×ª×¨×’×•× ×¢×‘×¨×™ ğŸ‘</button>
    <div id="audioHe" style="font-size:26px;color:var(--accent2);font-weight:700;margin-top:14px;display:none"></div>
  </div>
  <div class="audio-nav">
    <button class="btn btn-secondary" onclick="audioPrev()">â—€ ×”×§×•×“×</button>
    <button class="btn btn-primary" onclick="audioNext()">×”×‘× â–¶</button>
  </div>
  <div style="margin-top:16px;text-align:center">
    <button class="btn btn-secondary" onclick="audioShuffle()" style="max-width:200px">ğŸ”€ ×¢×¨×‘×‘</button>
  </div>
</div>

<!-- TEXT -->
<div id="text-mode" class="screen">
  <div class="top-bar">
    <button class="back-btn" onclick="goMenu()">â† ×ª×¤×¨×™×˜</button>
    <div class="mode-title">ğŸ“ ×›×ª×™×‘×” ×—×•×¤×©×™×ª</div>
  </div>
  <div class="text-instructions">
    ×›×ª×•×‘ <b>2 ×©×•×¨×•×ª</b> ×‘×× ×’×œ×™×ª ×¢× ×”××™×œ×™× ×©×œ××“×ª. × ×¡×” ×œ×”×©×ª××© ×œ×¤×—×•×ª ×‘-<b>3 ××™×œ×™× ××”×¨×©×™××”</b>. ×”××¢×¨×›×ª ×ª×ª×§×Ÿ ×©×’×™××•×ª ×•×ª×¡××Ÿ ××™×œ×™× × ×›×•× ×•×ª ××”×¨×©×™××”! ğŸŒŸ
  </div>
  <div style="color:var(--sub);font-size:13px;margin-bottom:8px">××™×œ×™× ×–××™× ×•×ª (××”×¨×©×™××”):</div>
  <div class="words-bank" id="wordBank"></div>
  <textarea class="text-area" id="freeText" placeholder="Write 2 lines using the vocabulary words..." maxlength="600"></textarea>
  <div class="action-row" style="margin-top:12px">
    <button class="btn btn-primary" onclick="checkFreeText()">âœ“ ×ª×§×Ÿ</button>
    <button class="btn btn-secondary" onclick="clearText()">ğŸ—‘ × ×§×”</button>
  </div>
  <div class="text-feedback" id="textFeedback"></div>
</div>

<script>
const words=[
{en:"another",he:"××—×¨"},
{en:"expert",he:"××•××—×”"},
{en:"fall asleep",he:"×œ×”×™×¨×“×"},
{en:"feather",he:"× ×•×¦×”"},
{en:"fur",he:"×¤×¨×•×•×”"},
{en:"make sure",he:"×œ×•×•×“×"},
{en:"mud",he:"×‘×•×¥"},
{en:"protect",he:"×œ×”×’×Ÿ"},
{en:"sand",he:"×—×•×œ"},
{en:"scale",he:"××©×§×œ"},
{en:"sunburn",he:"×›×•×•×™×”"},
{en:"sunscreen",he:"×§×¨× ×”×’× ×”"},
{en:"take care of",he:"×œ×“××•×’ ×œ"},
{en:"throw",he:"×œ×–×¨×•×§"},
{en:"wool",he:"×¦××¨"},
{en:"you're welcome",he:"×¢×œ ×œ× ×“×‘×¨"},
{en:"activity",he:"×¤×¢×™×œ×•×ª"},
{en:"adventure",he:"×”×¨×¤×ª×§××”"},
{en:"art",he:"××•×× ×•×ª"},
{en:"athlete",he:"××ª×œ×˜"},
{en:"change",he:"×œ×©× ×•×ª"},
{en:"company",he:"×—×‘×¨×”"},
{en:"competition",he:"×ª×—×¨×•×ª"},
{en:"creative",he:"×™×¦×™×¨×ª×™"},
{en:"date of birth",he:"×ª××¨×™×š ×œ×™×“×”"},
{en:"excellent",he:"××¦×•×™×™×Ÿ"},
{en:"free",he:"×—×•×¤×©×™, ×—×™× ×"},
{en:"get hurt",he:"×œ×”×™×¤×’×¢"},
{en:"in charge of",he:"××—×¨××™ ×¢×œ"},
{en:"look for",he:"×œ×—×¤×©"},
{en:"pay attention",he:"×œ×©×™× ×œ×‘"},
{en:"show",he:"×œ×”×¨××•×ª"},
{en:"sign",he:"×¡×™××Ÿ"},
{en:"sit still",he:"×œ×©×‘×ª ×‘×©×§×˜"},
{en:"start up",he:"×—×‘×¨×ª ×”×–× ×§"},
{en:"tidy",he:"××¡×•×“×¨"},
{en:"tour guide",he:"××“×¨×™×š ×˜×™×•×œ×™×"},
{en:"travel",he:"×œ×˜×™×™×œ"},
{en:"aim",he:"×›×•×•× ×”"},
{en:"beginning",he:"×”×ª×—×œ×”"},
{en:"celebrate",he:"×œ×—×’×•×’"},
{en:"choose",he:"×œ×‘×—×•×¨"},
{en:"countryside",he:"×›×¤×¨×™"},
{en:"download",he:"×œ×”×•×¨×™×“"},
{en:"event",he:"××¨×•×¢"},
{en:"exciting",he:"××¨×’×©"},
{en:"excuse",he:"×ª×™×¨×•×¥"},
{en:"expensive",he:"×™×§×¨"},
{en:"festival",he:"×¤×¡×˜×™×‘×œ"},
{en:"follow",he:"×œ×¢×§×•×‘"},
{en:"imagine",he:"×œ×“××™×™×Ÿ"},
{en:"in addition to",he:"×‘× ×•×¡×£ ×œ"},
{en:"in order to",he:"×›×“×™"},
{en:"left out",he:"× ×©××¨ ×‘×—×•×¥"},
{en:"light",he:"××•×¨"},
{en:"main",he:"×¨××©×™, ×¢×™×§×¨×™"},
{en:"perfect",he:"××•×©×œ×"},
{en:"pour",he:"×œ××–×•×’"},
{en:"route",he:"×“×¨×š, ××¡×œ×•×œ"},
{en:"seem",he:"× ×¨××”"},
{en:"success",he:"×”×¦×œ×—×”"},
{en:"suggestion",he:"×”×¦×¢×”"},
{en:"surprise",he:"×œ×”×¤×ª×™×¢"},
{en:"take part",he:"×œ×§×—×ª ×—×œ×§"},
{en:"take place",he:"×œ×”×ª×¨×—×©"},
{en:"team",he:"×§×‘×•×¦×”"},
{en:"tradition",he:"××¡×•×¨×ª"},
{en:"visit",he:"×œ×‘×§×¨"},
{en:"visitor",he:"××‘×§×¨"},
{en:"be used to",he:"×¨×’×™×œ ×œ"},
{en:"both and",he:"×’× ×•×’×"},
{en:"because of",he:"×‘×’×œ×œ"},
{en:"concentrate",he:"×œ×”×ª×¨×›×–"},
{en:"darkness",he:"×—×©×›×”"},
{en:"during",he:"×‘××©×š"},
{en:"get around",he:"×œ×”×¡×ª×“×¨"},
{en:"get up",he:"×œ×§×•×"},
{en:"go for a hike",he:"×œ×œ×›×ª ×œ×˜×™×•×œ"},
{en:"lake",he:"××’×"},
{en:"midnight",he:"×—×¦×•×ª"},
{en:"million",he:"××™×œ×™×•×Ÿ"},
{en:"rent",he:"×œ×©×›×•×¨"},
{en:"skate",he:"×œ×”×—×œ×™×§"},
{en:"sunlight",he:"××•×¨ ×©××©"},
{en:"tour",he:"×œ×˜×™×™×œ"},
{en:"tourist",he:"×ª×™×™×¨"},
{en:"turn into",he:"×œ×”×¤×•×š ×œ"},
{en:"unusual",he:"×œ× ×¨×’×™×œ"},
{en:"whatever",he:"×œ× ××©× ×” ××”"},
{en:"worry about",he:"×œ×“××•×’ ×œ"},
{en:"carefully",he:"×‘×–×”×™×¨×•×ª"},
{en:"collect",he:"×œ××¡×•×£"},
{en:"create",he:"×œ×™×¦×•×¨"},
{en:"dead",he:"××ª"},
{en:"drown",he:"×œ×˜×‘×•×¢"},
{en:"escape",he:"×œ×”×™××œ×˜"},
{en:"evil",he:"×¨×©×¢"},
{en:"feel sorry about",he:"××¨×—× ×¢×œ"},
{en:"god",he:"××œ×•×”×™×"},
{en:"guard",he:"×œ×©××•×¨"},
{en:"inventor",he:"×××¦×™×"},
{en:"island",he:"××™"},
{en:"pleased",he:"××¨×•×¦×”"},
{en:"prison",he:"×›×œ×"},
{en:"sculpture",he:"×¤×¡×œ"},
{en:"string",he:"×—×•×˜"},
{en:"tie",he:"×œ×§×©×•×¨"},
{en:"towards",he:"×œ×›×™×•×•×Ÿ"},
{en:"warn",he:"×œ×”×–×”×™×¨"},
{en:"wax",he:"×©×¢×•×•×”"},
{en:"wing",he:"×›× ×£"}
];

// sentences for mode 2 â€” one per word (using word in blank)
const sentences=[
{word:"another",template:"I need ______ pencil, this one is broken.",he:"×¢×•×“"},
{word:"expert",template:"She is an ______ in science.",he:"××•××—×”"},
{word:"fall asleep",template:"I always ______ during movies.",he:"×œ×”×™×¨×“×"},
{word:"feather",template:"The bird lost a ______ from its wing.",he:"× ×•×¦×”"},
{word:"fur",template:"The cat has very soft ______.",he:"×¤×¨×•×•×”"},
{word:"make sure",template:"Please ______ the door is locked.",he:"×œ×•×•×“×"},
{word:"mud",template:"The children played in the ______ after the rain.",he:"×‘×•×¥"},
{word:"protect",template:"Sunscreen helps ______ your skin.",he:"×œ×”×’×Ÿ"},
{word:"sand",template:"We built a castle in the ______.",he:"×—×•×œ"},
{word:"scale",template:"Step on the ______ to check your weight.",he:"××©×§×œ"},
{word:"sunburn",template:"He got a bad ______ at the beach.",he:"×›×•×•×™×”"},
{word:"sunscreen",template:"Always wear ______ on a sunny day.",he:"×§×¨× ×”×’× ×”"},
{word:"take care of",template:"She will ______ the dog while we travel.",he:"×œ×“××•×’ ×œ"},
{word:"throw",template:"Can you ______ the ball to me?",he:"×œ×–×¨×•×§"},
{word:"wool",template:"This sweater is made of warm ______.",he:"×¦××¨"},
{word:"activity",template:"Swimming is my favourite ______.",he:"×¤×¢×™×œ×•×ª"},
{word:"adventure",template:"Hiking in the mountains was a great ______.",he:"×”×¨×¤×ª×§××”"},
{word:"art",template:"She studies ______ at school.",he:"××•×× ×•×ª"},
{word:"athlete",template:"He is a professional ______ who runs every day.",he:"××ª×œ×˜"},
{word:"change",template:"I need to ______ my shoes before gym class.",he:"×œ×©× ×•×ª"},
{word:"company",template:"She works for a big technology ______.",he:"×—×‘×¨×”"},
{word:"competition",template:"We won first place in the ______.",he:"×ª×—×¨×•×ª"},
{word:"creative",template:"She is very ______ and loves painting.",he:"×™×¦×™×¨×ª×™"},
{word:"excellent",template:"You did an ______ job on the test!",he:"××¦×•×™×™×Ÿ"},
{word:"get hurt",template:"Be careful, you might ______!",he:"×œ×”×™×¤×’×¢"},
{word:"look for",template:"I always ______ my keys in the morning.",he:"×œ×—×¤×©"},
{word:"pay attention",template:"Please ______ when the teacher is speaking.",he:"×œ×©×™× ×œ×‘"},
{word:"tidy",template:"My room is always ______ and clean.",he:"××¡×•×“×¨"},
{word:"tour guide",template:"The ______ showed us the ancient city.",he:"××“×¨×™×š ×˜×™×•×œ×™×"},
{word:"travel",template:"I love to ______ to new countries.",he:"×œ×˜×™×™×œ"},
{word:"beginning",template:"The ______ of the book is very exciting.",he:"×”×ª×—×œ×”"},
{word:"celebrate",template:"We will ______ her birthday tonight.",he:"×œ×—×’×•×’"},
{word:"choose",template:"You can ______ any colour you like.",he:"×œ×‘×—×•×¨"},
{word:"exciting",template:"The football match was really ______.",he:"××¨×’×©"},
{word:"expensive",template:"This watch is very ______.",he:"×™×§×¨"},
{word:"festival",template:"We went to a music ______ last summer.",he:"×¤×¡×˜×™×‘×œ"},
{word:"follow",template:"Please ______ the instructions carefully.",he:"×œ×¢×§×•×‘"},
{word:"imagine",template:"Close your eyes and ______ a beautiful place.",he:"×œ×“××™×™×Ÿ"},
{word:"perfect",template:"The weather today is ______.",he:"××•×©×œ×"},
{word:"pour",template:"Can you ______ some water into my glass?",he:"×œ××–×•×’"},
{word:"route",template:"We took a scenic ______ through the forest.",he:"××¡×œ×•×œ"},
{word:"success",template:"Hard work leads to ______.",he:"×”×¦×œ×—×”"},
{word:"suggestion",template:"Do you have a ______ for a good restaurant?",he:"×”×¦×¢×”"},
{word:"take part",template:"Everyone is welcome to ______ in the game.",he:"×œ×§×—×ª ×—×œ×§"},
{word:"team",template:"Our football ______ won the championship.",he:"×§×‘×•×¦×”"},
{word:"tradition",template:"Lighting candles is a family ______.",he:"××¡×•×¨×ª"},
{word:"visit",template:"We plan to ______ Rome next summer.",he:"×œ×‘×§×¨"},
{word:"visitor",template:"A ______ came to our school today.",he:"××‘×§×¨"},
{word:"concentrate",template:"Turn off the music so I can ______.",he:"×œ×”×ª×¨×›×–"},
{word:"darkness",template:"He was afraid of the ______ in the room.",he:"×—×©×›×”"},
{word:"during",template:"We ate popcorn ______ the movie.",he:"×‘××©×š"},
{word:"lake",template:"We swam in the cool mountain ______.",he:"××’×"},
{word:"midnight",template:"The party ended at ______.",he:"×—×¦×•×ª"},
{word:"rent",template:"We will ______ a boat for the day.",he:"×œ×©×›×•×¨"},
{word:"skate",template:"She learned to ______ on ice last winter.",he:"×œ×”×—×œ×™×§"},
{word:"sunlight",template:"The room was full of warm ______.",he:"××•×¨ ×©××©"},
{word:"tourist",template:"Every ______ wants to see the Eiffel Tower.",he:"×ª×™×™×¨"},
{word:"unusual",template:"It is ______ to see snow in April.",he:"×œ× ×¨×’×™×œ"},
{word:"carefully",template:"She ______ carried the baby.",he:"×‘×–×”×™×¨×•×ª"},
{word:"collect",template:"I ______ stamps from different countries.",he:"×œ××¡×•×£"},
{word:"create",template:"She used recycled materials to ______ art.",he:"×œ×™×¦×•×¨"},
{word:"escape",template:"The prisoner managed to ______ from jail.",he:"×œ×”×™××œ×˜"},
{word:"guard",template:"A soldier will ______ the gate all night.",he:"×œ×©××•×¨"},
{word:"inventor",template:"Thomas Edison was a famous ______.",he:"×××¦×™×"},
{word:"island",template:"We sailed to a small ______ in the sea.",he:"××™"},
{word:"pleased",template:"The teacher was ______ with our work.",he:"××¨×•×¦×”"},
{word:"prison",template:"He was sent to ______ for ten years.",he:"×›×œ×"},
{word:"sculpture",template:"There is a beautiful marble ______ in the park.",he:"×¤×¡×œ"},
{word:"warn",template:"I tried to ______ him about the danger.",he:"×œ×”×–×”×™×¨"},
{word:"wing",template:"The bird broke its ______ and could not fly.",he:"×›× ×£"},
];

function shuffle(arr){return [...arr].sort(()=>Math.random()-.5)}

// Timer state - declared early so goMenu can reference it
const timers={
  mcq:{interval:null,seconds:0,running:false},
  sent:{interval:null,seconds:0,running:false},
  audio:{interval:null,seconds:0,running:false},
  text:{interval:null,seconds:0,running:false}
};

function goMenu(){
  ['mcq','sent'].forEach(k=>{
    const t=timers[k];
    if(t&&t.running){
      clearInterval(t.interval);t.running=false;
      const btn=document.getElementById(k+'TimerBtn');
      if(btn){btn.textContent='â–¶ ×©×¢×•×Ÿ';btn.classList.remove('running');}
    }
  });
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('menu').classList.add('active');
}
function show(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}

// ========== MCQ ==========
let mcqPool=[], mcqStage=1, mcqQNum=0, mcqStageScore=0, mcqTotalScore=0, mcqMistakes=[], mcqUsed=new Set();
let mcqAnswered=false;
let mcqStageWords=[]; // tracks exact 10 words shown this stage

// cycle tracking
let mcqCycle=[];
let mcqCycleIndex=0;

function startMCQ(){
  // create full cycle once
  mcqCycle = shuffle([...words]);
  mcqCycleIndex = 0;

  mcqPool=[];
  mcqUsed=new Set();
  mcqStage=1; mcqQNum=0; mcqStageScore=0; mcqTotalScore=0; mcqMistakes=[];
  mcqStageWords=[];
  document.getElementById('mcqRound').style.display='none';
  document.getElementById('mcqPlay').style.display='block';
  resetTimer('mcq');
  show('mcq');
  mcqNext();
}

function mcqNext(){
  if(mcqQNum>=10){
    showMCQRound(); return;
  }
  // ===== ensure batches without repetition =====
  if(mcqPool.length===0){

    // if finished full cycle â†’ reshuffle ALL words
    if(mcqCycleIndex >= mcqCycle.length){
      mcqCycle = shuffle([...words]);
      mcqCycleIndex = 0;
    }

    const remaining = mcqCycle.length - mcqCycleIndex;
    const take = Math.min(10, remaining);

    mcqPool = mcqCycle.slice(mcqCycleIndex, mcqCycleIndex + take);
    mcqCycleIndex += take;
  }

  const w = mcqPool.shift();
  mcqUsed.add(w.en);
  mcqStageWords.push(w);
  window._mcqCurrent=w;
  mcqAnswered=false;

  document.getElementById('mcqWord').textContent=w.en;

  // auto-start timer on first question of stage
  if(mcqQNum===0 && !timers.mcq.running){
    toggleTimer('mcq');
  }
  document.getElementById('mcqWord').className='question-word';

  let opts=[w.he];
  let pool=words.filter(x=>x.he!==w.he);
  shuffle(pool).slice(0,3).forEach(x=>opts.push(x.he));
  opts=shuffle(opts);

  const div=document.getElementById('mcqAnswers');
  div.innerHTML='';
  opts.forEach(o=>{
    const b=document.createElement('button');
    b.className='ans-btn'; b.textContent=o;
    b.onclick=()=>handleMCQ(b,o,w.he,w);
    div.appendChild(b);
  });
  updateMCQUI();
}

function handleMCQ(btn,selected,correct,w){
  if(mcqAnswered) return;
  mcqAnswered=true;
  document.querySelectorAll('.ans-btn').forEach(b=>b.disabled=true);
  if(selected===correct){
    btn.classList.add('correct');
    mcqStageScore++; mcqTotalScore++;
  } else {
    btn.classList.add('wrong');
    mcqMistakes.push(w);
    document.querySelectorAll('.ans-btn').forEach(b=>{if(b.textContent===correct)b.classList.add('correct');});
  }
  mcqQNum++;

  // if last question answered, stop timer
  if(mcqQNum>=10){
    pauseTimer('mcq');
  }
  updateMCQUI();
  setTimeout(mcqNext, 900);
}

function showMCQRound(){
  pauseTimer('mcq');
  document.getElementById('mcqPlay').style.display='none';
  const r=document.getElementById('mcqRound');
  r.style.display='block';
  document.getElementById('mcqRoundScore').textContent=mcqStageScore+'/10';
  document.getElementById('mcqRoundMsg').textContent=mcqStageScore>=8?'××¦×•×™×™×Ÿ! ğŸŒŸ':mcqStageScore>=5?'×›×œ ×”×›×‘×•×“! ×”××©×š ×œ×ª×¨×’×œ ğŸ’ª':'× ×¡×” ×©×•×‘, ××ª×” ×™×›×•×œ! ğŸ”';
  document.getElementById('mcqRoundTime').textContent=getTimerDisplay('mcq');
}

function retryMCQ(){
  // Replay exact same 10 words in shuffled order
  mcqPool=shuffle([...mcqStageWords]);
  mcqStageWords=[];
  mcqQNum=0; mcqStageScore=0; mcqMistakes=[];
  document.getElementById('mcqRound').style.display='none';
  document.getElementById('mcqPlay').style.display='block';
  resetTimer('mcq');
  mcqNext();
}

function continueMCQ(){
  mcqStage++; mcqQNum=0; mcqStageScore=0; mcqStageWords=[];
  document.getElementById('mcqRound').style.display='none';
  document.getElementById('mcqPlay').style.display='block';
  resetTimer('mcq');
  if(mcqStage>10){alert('ğŸŠ ×¡×™×™××ª ××ª ×›×œ ×”×©×œ×‘×™×! ××ª×—×™×œ ××—×“×©...');mcqStage=1;mcqTotalScore=0;}
  mcqNext();
}

function updateMCQUI(){
  document.getElementById('mcqStage').textContent=mcqStage;

  // update stage total based on word count
  const totalStages = Math.max(1, Math.ceil(words.length/10));
  const totalEl = document.getElementById('mcqStageTotal');
  if(totalEl) totalEl.textContent = totalStages;
  document.getElementById('mcqQ').textContent=mcqQNum;
  document.getElementById('mcqStageScore').textContent=mcqStageScore;
  document.getElementById('mcqTotal').textContent=mcqTotalScore;
  document.getElementById('mcqBar').style.width=(mcqQNum/10*100)+'%';
}

// ========== SENTENCES ==========
let sentPool=[], sentIdx=0, sentStageNum=1, sentQNum=0, sentStageScore=0, sentTotalScore=0;
// cycle tracking for no-repeat
let sentCycle=[];
let sentCycleIndex=0;
let sentAnswered=false, sentHintLevel=0;
let sentStageSentences=[]; // tracks exact 10 sentences shown this stage

function startSentences(){
  ensureSentencesCoverage();

  // create full cycle
  sentCycle = shuffle([...sentences]);
  sentCycleIndex = 0;

  sentPool=[];

  sentIdx=0; sentStageNum=1; sentQNum=0; sentStageScore=0; sentTotalScore=0;
  sentStageSentences=[];
  document.getElementById('sentRound').style.display='none';
  document.getElementById('sentPlay').style.display='block';
  document.getElementById('hintBox').style.display='none';
  resetTimer('sent');
  show('sentences');
  loadSent();
}

function loadSent(){
  if(sentQNum>=10){showSentRound();return;}
  // ensure no repetition until full cycle finished
  if(sentPool.length===0){
    if(sentCycleIndex >= sentCycle.length){
      sentCycle = shuffle([...sentences]);
      sentCycleIndex = 0;
    }
    const remaining = sentCycle.length - sentCycleIndex;
    const take = Math.min(10, remaining);
    sentPool = sentCycle.slice(sentCycleIndex, sentCycleIndex + take);
    sentCycleIndex += take;
    sentIdx = 0;
  }
  const s=sentPool[sentIdx++];
  sentStageSentences.push(s); // record for retry
  window._sentCurrent=s;
  sentAnswered=false;
  sentHintLevel=0;

  const parts=s.template.split('______');
  document.getElementById('sentText').innerHTML=
    parts[0]+'<span class="blank">______</span>'+(parts[1]||'');
  document.getElementById('sentInput').value='';
  document.getElementById('sentInput').className='sent-input';
  document.getElementById('sentFeedback').textContent='';
  document.getElementById('hintBox').style.display='none';
  document.getElementById('hintInfo').textContent='';

  const hBtn=document.getElementById('hintBtn');
  hBtn.textContent='ğŸ’¡ ×¨××– 1';
  hBtn.disabled=false;
  hBtn.style.opacity='1';

  // auto-start timer on first question of stage
  if(sentQNum===0 && !timers.sent.running){
    toggleTimer('sent');
  }
  updateSentUI();
  setTimeout(()=>document.getElementById('sentInput').focus(),100);
}

function checkSent(){
  if(sentAnswered) return;
  const s=window._sentCurrent;
  const val=document.getElementById('sentInput').value.trim().toLowerCase();
  const correct=s.word.toLowerCase();
  sentAnswered=true;

  const inp=document.getElementById('sentInput');
  const fb=document.getElementById('sentFeedback');

  if(val===correct){
    inp.classList.add('correct-input');
    const pts=Math.max(1, 3-sentHintLevel);
    fb.style.color='var(--green)';
    if(sentHintLevel===0) fb.textContent=`âœ… × ×›×•×Ÿ! +${pts} × ×§×•×“×•×ª ğŸŒŸ`;
    else fb.textContent=`âœ… × ×›×•×Ÿ! +${pts} × ×§×•×“×•×ª`;
    sentStageScore+=pts; sentTotalScore+=pts;
  } else {
    inp.classList.add('wrong-input');
    fb.style.color='var(--red)';
    fb.textContent='âŒ ×œ× × ×›×•×Ÿ. ×”×ª×©×•×‘×” ×”× ×›×•× ×”: '+s.word;
  }
  sentQNum++;
  // stop timer if stage finished
  if(sentQNum>=10){
    pauseTimer('sent');
  }
  // stop timer if stage finished
  if(sentQNum>=10){
    pauseTimer('sent');
  }
  // auto-start timer on first question of stage
  if(sentQNum===0 && !timers.sent.running){
    toggleTimer('sent');
  }
  updateSentUI();

  const hBtn=document.getElementById('hintBtn');
  hBtn.disabled=true; hBtn.style.opacity='.4';

  setTimeout(()=>{
    if(sentQNum>=10){showSentRound();}
    else{loadSent();}
  },1400);
}

function skipSent(){
  if(sentAnswered) return;
  sentAnswered=true;
  sentQNum++;
  // stop timer if stage finished
  if(sentQNum>=10){
    pauseTimer('sent');
  }
  // auto-start timer on first question of stage
  if(sentQNum===0 && !timers.sent.running){
    toggleTimer('sent');
  }
  updateSentUI();
  document.getElementById('sentFeedback').textContent='';
  if(sentQNum>=10){setTimeout(showSentRound,400);}
  else{loadSent();}
}

function wordType(w){
  const he=(w.he||'');
  const en=(w.en||w.word||'').toLowerCase();
  if(he.startsWith('×œ')) return 'verb';
  if(en.endsWith('ly')) return 'adverb';
  if(en.endsWith('ful')||en.endsWith('ous')||en.endsWith('ive')||en.endsWith('al')||en.endsWith('ent')) return 'adj';
  return 'noun';
}


function showSentHint(){
  if(sentAnswered) return;

  const s=window._sentCurrent;
  const hBtn=document.getElementById('hintBtn');
  const hintBox=document.getElementById('hintBox');
  const hintTitle=document.getElementById('hintTitle');
  const hintOpts=document.getElementById('hintOpts');
  const hintInfo=document.getElementById('hintInfo');

  // ===== Hint 1 =====
  if(sentHintLevel===0){
    sentHintLevel=1;

    hintTitle.textContent='ğŸ’¡ ×¨××–×™×:';

    hintOpts.innerHTML=`
      <div style="font-size:13px;color:var(--sub);margin-bottom:6px">
        ×¨××– 1 â€“ ×ª×¨×’×•×:
      </div>
      <div style="font-size:22px;color:var(--accent2);font-weight:700;padding:8px">
        ${s.he}
      </div>
    `;

    hintBox.style.display='block';
    hintInfo.textContent='×©×™××•×© ×‘×¨××– 1 â†’ ×ª×©×•×‘×” × ×›×•× ×” = 2 × ×§×•×“×•×ª';
    hintInfo.style.color='var(--accent)';
    hBtn.textContent='ğŸ’¡ ×¨××– 2';
    return;
  }

  // ===== Hint 2 =====
  if(sentHintLevel===1){
    sentHintLevel=2;

    const correctWord=s.word;

    // distractors only from existing words list
    let distractors=shuffle(
      words
        .map(w=>w.en)
        .filter(en=>en.toLowerCase()!==correctWord.toLowerCase())
    ).slice(0,2);

    const opts=shuffle([correctWord,...distractors]);

    // Append under hint 1 (do NOT replace)
    hintOpts.innerHTML+=`
      <div style="width:100%;height:10px"></div>
      <div style="font-size:13px;color:var(--sub);margin-bottom:6px">
        ×¨××– 2 â€“ ×‘×—×¨ ××”××¤×©×¨×•×™×•×ª:
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;width:100%">
        ${opts.map(o=>`
          <div class="hint-opt" onclick="pickHint('${o.replace(/'/g,"\'")}')">
            ${o}
          </div>
        `).join('')}
      </div>
    `;

    hintInfo.textContent='×©×™××•×© ×‘×¨××– 2 â†’ ×ª×©×•×‘×” × ×›×•× ×” = 1 × ×§×•×“×” ×‘×œ×‘×“';
    hintInfo.style.color='var(--red)';
    hBtn.textContent='××™×Ÿ ×¢×•×“ ×¨××–×™×';
    hBtn.disabled=true;
    hBtn.style.opacity='.4';
  }
}


function pickHint(opt){
  document.getElementById('sentInput').value=opt;
  document.getElementById('sentInput').focus();
}

function showSentRound(){
  pauseTimer('sent');
  document.getElementById('sentPlay').style.display='none';
  const r=document.getElementById('sentRound');
  r.style.display='block';
  document.getElementById('sentRoundScore').textContent=sentStageScore+'/30';
  document.getElementById('sentRoundMsg').textContent=sentStageScore>=25?'××¦×•×™×™×Ÿ! ğŸŒŸ':sentStageScore>=18?'×™×¤×” ×××•×“! ğŸ’ª':'× ×¡×” ×©×•×‘! ğŸ”';
  document.getElementById('sentRoundTime').textContent=getTimerDisplay('sent');
}

function retrySent(){
  // Replay exact same 10 sentences in shuffled order
  sentPool=shuffle([...sentStageSentences]);
  sentStageSentences=[];
  sentIdx=0; sentQNum=0; sentStageScore=0;
  document.getElementById('sentRound').style.display='none';
  document.getElementById('sentPlay').style.display='block';
  document.getElementById('hintBox').style.display='none';
  resetTimer('sent');
  loadSent();
}

function continueSent(){
  sentStageNum++; sentQNum=0; sentStageScore=0; sentStageSentences=[];
  document.getElementById('sentRound').style.display='none';
  document.getElementById('sentPlay').style.display='block';
  resetTimer('sent');
  loadSent();
}

function updateSentUI(){
  // total stages for sentences
  const _sentTotalStages = Math.max(1, Math.ceil(sentences.length/10));
  const _sentTotalEl = document.getElementById('sentStageTotal');
  if(_sentTotalEl) _sentTotalEl.textContent = _sentTotalStages;

  document.getElementById('sentStage').textContent=sentStageNum;
  document.getElementById('sentQ').textContent=sentQNum;
  document.getElementById('sentScore').textContent=sentStageScore;
  document.getElementById('sentTotal').textContent=sentTotalScore;
  document.getElementById('sentBar').style.width=(sentQNum/10*100)+'%';
}

// ========== AUDIO ==========
let audioList=[], audioPos=0, audioRevealed=false;

function startAudio(){
  audioList=shuffle(words);
  audioPos=0;
  resetTimer('audio');
  show('audio-mode');
  loadAudio();
}

function loadAudio(){
  audioRevealed=false;
  const w=audioList[audioPos];
  document.getElementById('audioEn').textContent=w.en;
  document.getElementById('audioHe').textContent=w.he;
  document.getElementById('audioHe').style.display='none';
  document.getElementById('audioRevealBtn').textContent='×”×¦×’ ×ª×¨×’×•× ×¢×‘×¨×™ ğŸ‘';
  document.getElementById('audioIdx').textContent=audioPos+1;
  document.getElementById('audioTotal').textContent=audioList.length;
}

function speakCurrent(){
  const w=audioList[audioPos];
  if('speechSynthesis' in window){
    const u=new SpeechSynthesisUtterance(w.en);
    u.lang='en-US'; u.rate=0.85;
    speechSynthesis.cancel();
    speechSynthesis.speak(u);
  } else {
    alert('×”×©××¢ ××™× ×• × ×ª××š ×‘×“×¤×“×¤×Ÿ ×–×”');
  }
}

function toggleReveal(){
  audioRevealed=!audioRevealed;
  document.getElementById('audioHe').style.display=audioRevealed?'block':'none';
  document.getElementById('audioRevealBtn').textContent=audioRevealed?'×”×¡×ª×¨ ×¢×‘×¨×™×ª ğŸ™ˆ':'×”×¦×’ ×ª×¨×’×•× ×¢×‘×¨×™ ğŸ‘';
}

function audioNext(){
  if(audioPos<audioList.length-1){audioPos++;}
  else{audioPos=0;}
  loadAudio();
}

function audioPrev(){
  if(audioPos>0){audioPos--;}
  else{audioPos=audioList.length-1;}
  loadAudio();
}

function audioShuffle(){
  audioList=shuffle(words);
  audioPos=0;
  loadAudio();
}

// ========== TEXT MODE ==========
function startText(){
  show('text-mode');
  document.getElementById('freeText').value='';
  document.getElementById('textFeedback').style.display='none';
  resetTimer('text');
  buildWordBank();
}

function buildWordBank(){
  const bank=document.getElementById('wordBank');
  bank.innerHTML=shuffle(words).slice(0,30).map(w=>
    `<div class="word-chip" data-en="${w.en}">${w.en}</div>`
  ).join('');
}

function clearText(){
  document.getElementById('freeText').value='';
  document.getElementById('textFeedback').style.display='none';
  buildWordBank();
}

function checkFreeText(){
  const text=document.getElementById('freeText').value.trim();
  if(!text){alert('×× × ×›×ª×•×‘ ×œ×¤×—×•×ª ××©×¤×˜ ××—×“');return;}

  const fb=document.getElementById('textFeedback');
  fb.style.display='block';

  const lines=text.split('\n').filter(l=>l.trim());
  
  // Find which vocab words are used
  const usedWords=[];
  words.forEach(w=>{
    const re=new RegExp('\\b'+w.en.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')+'\\b','gi');
    if(re.test(text)) usedWords.push(w.en);
  });

  // Simple spell check + highlight
  let html=`<div class="text-feedback-title">ğŸ“‹ ×ª×™×§×•×Ÿ ×•×‘×“×™×§×”</div>`;
  
  html+=`<div style="margin-bottom:12px;color:var(--accent2);font-size:14px">
    âœ¨ ××™×œ×•×ª ××•×¦×¨ ×©××¦××ª×™: <b style="color:var(--green)">${usedWords.length>0?usedWords.join(', '):'××£ ××™×œ×” ××”×¨×©×™××”'}</b>
  </div>`;

  // Common corrections map
  const corrections={
    'dont':"don't",'cant':"can't",'wont':"won't",'isnt':"isn't",
    'wasnt':"wasn't",'didnt':"didn't",'havent':"haven't",
    'im':"I'm",'ive':"I've",'id':"I'd",'ill':"I'll",
    'i ':'I ','teh':'the','recieve':'receive','occured':'occurred',
    'seperate':'separate','definately':'definitely','untill':'until',
    'alot':'a lot','becuase':'because','freind':'friend','wierd':'weird',
    'beutiful':'beautiful','excelent':'excellent','adveture':'adventure',
    'begining':'beginning','successfull':'successful',
  };

  let corrected=text;
  const applied=[];
  Object.entries(corrections).forEach(([wrong,right])=>{
    const re=new RegExp('\\b'+wrong+'\\b','gi');
    if(re.test(corrected)){
      corrected=corrected.replace(re,right);
      applied.push({wrong,right});
    }
  });

  if(applied.length>0){
    html+=`<div style="margin-bottom:10px;color:var(--sub);font-size:13px">ğŸ”§ ×ª×™×§×•× ×™× ×©× ××¦××•:</div>`;
    applied.forEach(a=>{
      html+=`<div class="correction-line"><span class="err-word">${a.wrong}</span> â†’ <span class="corr-word">${a.right}</span></div>`;
    });
    html+=`<div style="margin:12px 0;padding:12px;background:var(--card);border-radius:8px;direction:ltr;font-size:16px;line-height:1.8">${corrected}</div>`;
  } else {
    html+=`<div class="ok-line">âœ… ×œ× × ××¦××• ×©×’×™××•×ª ×›×ª×™×‘! ×›×œ ×”×›×‘×•×“!</div>`;
  }

  // Encourage
  if(usedWords.length>=5) html+=`<div style="margin-top:10px;color:var(--accent);font-weight:700">ğŸ† ××“×”×™×! ×”×©×ª××©×ª ×‘-${usedWords.length} ××™×œ×•×ª ××•×¦×¨!</div>`;
  else if(usedWords.length>=3) html+=`<div style="margin-top:10px;color:var(--green)">â­ ×™×¤×” ×××•×“! × ×¡×” ×œ×”×›× ×™×¡ ×¢×•×“ ××™×œ×•×ª ××•×¦×¨.</div>`;
  else if(usedWords.length>0) html+=`<div style="margin-top:10px;color:var(--sub)">ğŸ’¡ × ×¡×” ×œ×”×©×ª××© ×‘×™×•×ª×¨ ××™×œ×•×ª ××•×¦×¨ ××”×¨×©×™××”.</div>`;

  fb.innerHTML=html;

  // Highlight used chips in word bank
  document.querySelectorAll('.word-chip').forEach(chip=>{
    if(usedWords.includes(chip.dataset.en)) chip.classList.add('used');
    else chip.classList.remove('used');
  });
}
// ========== TIMER ENGINE ==========
function fmtTime(s){
  const m=Math.floor(s/60);
  const sec=s%60;
  return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0');
}

function toggleTimer(key){
  const t=timers[key];
  const btn=document.getElementById(key+'TimerBtn');
  const disp=document.getElementById(key+'TimerDisplay');
  if(t.running){
    clearInterval(t.interval);
    t.running=false;
    if(btn){btn.textContent='â–¶ ×©×¢×•×Ÿ';btn.classList.remove('running');}
  } else {
    t.running=true;
    if(btn){btn.textContent='â¸ ×¢×¦×•×¨';btn.classList.add('running');}
    t.interval=setInterval(()=>{
      t.seconds++;
      if(disp) disp.textContent=fmtTime(t.seconds);
    },1000);
  }
}

function resetTimer(key){
  const t=timers[key];
  clearInterval(t.interval);
  t.running=false;
  t.seconds=0;
  const disp=document.getElementById(key+'TimerDisplay');
  if(disp) disp.textContent='00:00';
  const btn=document.getElementById(key+'TimerBtn');
  if(btn){btn.textContent='â–¶ ×©×¢×•×Ÿ';btn.classList.remove('running');}
}

function pauseTimer(key){
  const t=timers[key];
  if(t.running){
    clearInterval(t.interval);
    t.running=false;
    const btn=document.getElementById(key+'TimerBtn');
    if(btn){btn.textContent='â–¶ ×©×¢×•×Ÿ';btn.classList.remove('running');}
  }
}

function getTimerDisplay(key){return fmtTime(timers[key].seconds);}

// ========== CUSTOM WORDS ==========
const defaultWords=[...words];
const defaultSentences=[...sentences];

function showCustomWords(){
  show('custom-words');
  document.getElementById('customFeedback').textContent='';
  document.getElementById('fileStatus').textContent='';
  document.getElementById('customLoading').style.display='none';
  document.getElementById('customBtns').style.display='flex';
  document.getElementById('customInput').disabled=false;
}

async function handleFileUpload(event){
  const file=event.target.files[0];
  if(!file) return;
  const statusEl=document.getElementById('fileStatus');
  statusEl.style.color='var(--accent2)';
  statusEl.textContent='×§×•×¨× ×§×•×‘×¥...';

  try{
    let text='';
    if(file.name.endsWith('.txt')){
      text=await file.text();

    } else if(file.name.endsWith('.docx')||file.name.endsWith('.doc')){
      const arrayBuffer=await file.arrayBuffer();
      if(typeof mammoth!=='undefined'){
        const result=await mammoth.extractRawText({arrayBuffer});
        text=result.value;
      } else {
        const decoder=new TextDecoder('utf-8');
        const raw=decoder.decode(arrayBuffer);
        text=raw.replace(/[^\x20-\x7E\n\r\u0590-\u05FF]/g,' ').replace(/\s+/g,' ').trim();
      }

    } else if(file.name.endsWith('.pdf')){
      const arrayBuffer=await file.arrayBuffer();
      if(typeof pdfjsLib!=='undefined'){
        pdfjsLib.GlobalWorkerOptions.workerSrc=
          'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
        const pages=[];
        for(let i=1;i<=pdf.numPages;i++){
          const page=await pdf.getPage(i);
          const content=await page.getTextContent();
          pages.push(content.items.map(item=>item.str).join(' '));
        }
        text=pages.join('\n');
      } else {
        statusEl.style.color='var(--red)';
        statusEl.textContent='âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ PDF ×›×¨×’×¢. × ×¡×” ×©×•×‘.';
        return;
      }
    }

    if(!text.trim()){
      statusEl.style.color='var(--red)';
      statusEl.textContent='âš ï¸ ×œ× × ×™×ª×Ÿ ×œ×§×¨×•× ××ª ×”×§×•×‘×¥';
      return;
    }

    document.getElementById('customInput').value=text;
    statusEl.style.color='var(--green)';
    statusEl.textContent=`âœ… ×”×§×•×‘×¥ "${file.name}" × ×˜×¢×Ÿ â€” ×‘×“×•×§ ××ª ×”×ª×•×›×Ÿ ×•×œ×—×¥ "×˜×¢×Ÿ ××™×œ×™×"`;
  } catch(e){
    statusEl.style.color='var(--red)';
    statusEl.textContent='âš ï¸ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥. × ×¡×” ×œ×”×¢×ª×™×§ ×•×œ×”×“×‘×™×§ ×™×“× ×™×ª.';
  }
  event.target.value='';
}

function parseWordList(raw){
  const parsed=[];
  const separators=[/\s*=\s*/,/\s*-\s*/,/\s*:\s*/,/\s*\|\s*/,/\t/];
  raw.split('\n').forEach(line=>{
    line=line.trim();
    if(!line) return;
    for(const sep of separators){
      const parts=line.split(sep);
      if(parts.length>=2){
        const en=parts[0].trim();
        const he=parts.slice(1).join(' ').trim();
        if(en && he){parsed.push({en,he});break;}
      }
    }
  });
  return parsed;
}

// ===== WORD BANK FOR DISTRACTORS (not AI, built-in) =====
const WORD_BANK={
  verb:['run','jump','think','write','speak','listen','read','travel','work','study',
        'cook','clean','drive','walk','swim','sing','dance','laugh','cry','sleep',
        'wake','eat','drink','play','teach','learn','build','fix','open','close',
        'find','lose','send','receive','buy','sell','help','ask','answer','try',
        'stop','start','finish','remember','forget','explain','describe','choose',
        'decide','change','move','stay','leave','arrive','return','visit','meet',
        'see','hear','feel','touch','smell','believe','understand','realize','know'],
  noun:['book','table','chair','window','door','school','teacher','student','friend',
        'family','house','garden','park','city','village','country','market','shop',
        'doctor','nurse','hospital','medicine','problem','solution','idea','plan',
        'story','picture','letter','word','sentence','question','answer','lesson',
        'paper','pen','bag','phone','computer','camera','car','bicycle','train',
        'airplane','hotel','restaurant','food','water','coffee','tree','flower',
        'animal','dog','cat','bird','fish','mountain','river','beach','forest',
        'weather','rain','snow','sun','wind','cloud','season','morning','evening'],
  adj:['happy','sad','angry','tired','excited','bored','nervous','calm','busy',
       'free','strong','weak','fast','slow','big','small','tall','short','young',
       'old','new','old','hot','cold','warm','cool','clean','dirty','easy','hard',
       'loud','quiet','bright','dark','beautiful','ugly','interesting','boring',
       'important','simple','complex','careful','careless','kind','rude','honest',
       'friendly','serious','funny','clever','stupid','healthy','sick','safe','dangerous']
};

function wordType(w){
  const he=(w.he||w||'');
  const en=(w.en||w||'').toLowerCase();
  if(typeof he==='string' && he.startsWith('×œ')) return 'verb';
  if(en.endsWith('ly')) return 'adverb';
  if(en.endsWith('ful')||en.endsWith('ous')||en.endsWith('ive')||en.endsWith('al')||en.endsWith('ent')) return 'adj';
  return 'noun';
}

function generateSentences(wordList){
  // All uploaded words as a set for exclusion
  const uploadedWords=new Set(wordList.map(w=>w.en.toLowerCase()));

  function makeSentence(en, he){
    const h=he.trim();
    if(h.startsWith('×œ')){
      return `She wanted to ______ but she did not know how.`;
    }
    return `The English word for this concept is ______.`;
  }

  return wordList.map(w=>({
    word: w.en,
    template: makeSentence(w.en, w.he),
    he: w.he,
    type: wordType(w)
  }));
}
// ===== END WORD BANK =====
async function loadCustomWords(){
  const raw=document.getElementById('customInput').value.trim();
  if(!raw){
    document.getElementById('customFeedback').style.color='var(--red)';
    document.getElementById('customFeedback').textContent='âš ï¸ ×× × ×”×“×‘×§ ×¨×©×™××ª ××™×œ×™×';
    return;
  }

  const parsed=parseWordList(raw);
  if(parsed.length<2){
    document.getElementById('customFeedback').style.color='var(--red)';
    document.getElementById('customFeedback').textContent='âš ï¸ ×œ× × ××¦××• ××™×œ×™×. ×•×“× ×©×”×¤×•×¨××˜ × ×›×•×Ÿ (××™×œ×” = ×ª×¨×’×•×)';
    return;
  }

  document.getElementById('customBtns').style.display='none';
  document.getElementById('customLoading').style.display='block';
  document.getElementById('loadingProgress').textContent=`××¢×‘×“ ${parsed.length} ××™×œ×™×...`;
  document.getElementById('customFeedback').textContent='';
  document.getElementById('customInput').disabled=true;

  await new Promise(r=>setTimeout(r,300));

  const newSentences=generateSentences(parsed);

  words.length=0;
  parsed.forEach(w=>words.push(w));
  sentences.length=0;
  newSentences.forEach(s=>sentences.push(s));

  updateMCQStageCount();
  updateWordCount();
  document.getElementById('menuSub').textContent=
    `${words.length} ××™×œ×™× ××•×ª×××•×ª ××™×©×™×ª | 4 ××¦×‘×™ ×ª×¨×’×•×œ`;

  document.getElementById('customLoading').style.display='none';
  document.getElementById('customFeedback').style.color='var(--green)';
  document.getElementById('customFeedback').textContent=
    `âœ… × ×˜×¢× ×• ${parsed.length} ××™×œ×™× ×•-${newSentences.length} ××©×¤×˜×™×!`;
  document.getElementById('customBtns').style.display='flex';
  document.getElementById('customInput').disabled=false;

  setTimeout(()=>goMenu(),1000);
}

function resetToDefault(){
  words.length=0;
  defaultWords.forEach(w=>words.push(w));
  sentences.length=0;
  defaultSentences.forEach(s=>sentences.push(s));
  updateMCQStageCount();
  updateWordCount();
  document.getElementById('menuSub').textContent='111 ××™×œ×™× | 4 ××¦×‘×™ ×ª×¨×’×•×œ';
  document.getElementById('customInput').value='';
  document.getElementById('customFeedback').style.color='var(--green)';
  document.getElementById('customFeedback').textContent='âœ… ×—×–×¨×ª ×œ×¨×©×™××ª ×”××™×œ×™× ×”××§×•×¨×™×ª';
  setTimeout(()=>goMenu(),800);
}

function updateMCQStageCount(){
  const totalStages = Math.max(1, Math.ceil(words.length/10));
  const el = document.getElementById('mcqMenuStages');
  if(el) el.textContent = totalStages;
}

updateMCQStageCount();

function updateWordCount(){
  const el=document.getElementById('wordCount');
  if(el) el.textContent = words.length;
}

updateWordCount();

function showMCQSummary(){
  const box=document.getElementById('mcqSummaryBox');
  if(!box) return;
  if(mcqMistakes.length===0){
    box.innerHTML='ğŸ‰ ×œ× ×”×™×• ×˜×¢×•×™×•×ª ×‘×©×œ×‘ ×”×–×”!';
  }else{
    box.innerHTML='<b>×˜×¢×•×™×•×ª ×‘×©×œ×‘:</b><br>'+
      mcqMistakes.map(w=>`â€¢ ${w.en} â†’ ${w.he}`).join('<br>');
  }
  box.style.display='block';
}


function ensureSentencesCoverage(){
  if(sentences.length >= words.length) return;

  const existing = new Set(sentences.map(s=>s.word.toLowerCase()));
  words.forEach(w=>{
    if(!existing.has(w.en.toLowerCase())){
      sentences.push({
        word:w.en,
        template:`I often use ______ in my daily life.`,
        he:w.he
      });
    }
  });
}

</script>
